{% extends "mouse_cat/base.html" %}

{% load staticfiles %}

{% block content %}


<script type="text/javascript">

function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
var csrftoken = getCookie('csrftoken');

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

$(document).ready(addDragDrop);

function addDragDrop() {
    $(document).on('dragover','.drop', function(e){
        e.preventDefault();
    });
    $(document).on('dragstart','.drag', function(e){
        e.originalEvent.dataTransfer.setData('object', e.target.id);
    });
    $(document).on('drop','.drop', function(e){
        e.preventDefault();
        var board = {{board}};
        var data = e.originalEvent.dataTransfer.getData('object');
        if ("{{game.mouse_user.id}}" === "{{request.user.id}}") {
            if (board[parseInt(data.split('_')[1], 10)][parseInt(data.split('_')[0], 10)] === -1){
                do_move(parseInt(data.split('_')[0], 10) +parseInt(data.split('_')[1], 10)*8, parseInt(e.target.id.split('_')[1], 10) +parseInt(e.target.id.split('_')[2], 10)*8);
                e.target.appendChild(document.getElementById(data));
                $(this).off('dragover drop');
            }
        } else {
            if ([1,2,3,4].includes(board[parseInt(data.split('_')[1], 10)][parseInt(data.split('_')[0], 10)])) {
                do_move(parseInt(data.split('_')[0], 10) +parseInt(data.split('_')[1], 10)*8, parseInt(e.target.id.split('_')[1], 10) +parseInt(e.target.id.split('_')[2], 10)*8);
                e.target.appendChild(document.getElementById(data));
                $(this).off('dragover drop');
            }
        }
    });
}
var loopTurn;


function do_move(o, t) {
    /* REVISAR: Habia puesto esto para cuando intentas poner una pieza encima de otra que no sea valido,
    pero en caso de ser cat encima de pacman si que es valido, porque se comen...*/
    if (isNaN(t)){
        alert("Movimiento invalido");
        $( "#err_move").fadeIn("slow");

                /* Sacamos las coordenadas buenas*/
        var origin_x = o % 8;
        var origin_y = Math.trunc(t/8);
        var target_x = o % 8;
        var target_y = Math.trunc(t/8);


        var origin_cell = document.getElementById("cell_"+origin_x+"_"+origin_y);
        var target_cell = document.getElementById("cell_"+target_x+"_"+target_y);

        var move_aux = origin_cell.innerHTML;

        target_cell.innerHTML = move_aux;

        origin_cell.innerText = "";
    }

    else{
        $.ajax({
        type: "POST",
        url: '{% url 'move' %}',
        token: csrftoken,
        data: {
            origin: o,
            target: t,
            action: 'post'
        },
        success: function (data) {
            $( "#chess_div").html('').load("{% url 'create_only_board' game_id=game.id %}");
            loopTurn = setInterval(checkTurn,2000);
            $( "#waiting").fadeIn("slow");
            if ("{{game.mouse_user}}" === "{{request.user}}")
            {
                $( "#mouse_turn").fadeOut("slow");
                $( "#cat_turn").fadeIn("slow");
            }
            else if ("{{game.mouse_user}}" !== "{{request.user}}")
            {
                $( "#cat_turn").fadeOut("slow");
                $( "#mouse_turn").fadeIn("slow");
            }
        }
        });
    }

}

function checkTurn(){
        $.ajax({
            url: '{% url 'turn' game_id=game.id %}',
            token: csrftoken,
            type: 'post',
            success: function(response){
                if (response.turn === false && "{{game.mouse_user.id}}" === "{{request.user.id}}")
                {
                    clearInterval(loopTurn);
                    location.reload(true);
                    $( "#waiting").fadeOut("slow");
                    $( "#mouse_turn").fadeIn("slow");
                    $( "#cat_turn").fadeOut("slow");
                }
                else if (response.turn === true && "{{game.mouse_user.id}}" !== "{{request.user.id}}")
                {
                    clearInterval(loopTurn);
                    location.reload(true);
                    $( "#waiting").fadeOut("slow");
                    $( "#cat_turn").fadeIn("slow");
                    $( "#mouse_turn").fadeOut("slow");
                }
            }
        });
    }

</script>


<div class="container-fluid text-center old_ratonGato">

  <div class="row content">
    <div class="col-sm-2 sidenav izquierda">
        {% if request.user == game.cat_user %}
            Tu:
           <b>{{ game.cat_user.username }}</b>
            <br/>
           <img src="{{ baseUrl }}/img/personajes/char1.png" alt="cat" class="imagestylesmall"></a>
        {% else %}
            Rival:
           <b>{{ game.cat_user.username }}</b>
            <br/>
            <img src="{{ baseUrl }}/img/personajes/char1.png" alt="cat" class="imagestylesmall"></a>

        {% endif %}



        {% if game.mouse_user.id == request.user.id %}
            <div id="waiting" style="display: none">
                Esperando rival...
                <div class="gooey">
                  <span class="dot"></span>
                  <div class="dots">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>
                </div>
            </div>
        {% endif %}


    </div>

    <div id="chess_div" class="col-sm-8 text-left">
        <div class="turn_advisor">
        {% if game.cat_turn %}
            <div id="cat_turn" style="visibility: visible">Turno CAT</div>
        {% else %}
            <div id="cat_turn" style="display: none">Turno CAT</div>
        {% endif %}

                  {% if game.cat_turn %}
                <div id="mouse_turn" style="display: none">Turno PAC</div>
            {% else %}
                <div id="mouse_turn" style="visibility: visible">Turno PAC</div>
            {% endif %}
        </div>
      {% include 'mouse_cat/board.html' %}
        <div id="err_move"><strong>Movimiento no permitido</strong></div>

    </div>
    <div class="col-sm-2 sidenav derecha">
      <div class="well">
            {% if request.user == game.mouse_user %}
            Tu:
            <b>{{ game.mouse_user.username }}</b>
            <br/>

           <img src="{{ baseUrl }}/img/personajes/main.png" alt="pac" class="imagestylesmall"></a>
            {% else %}
            Rival:
            <b>{{ game.mouse_user.username }}</b>
            <br/>

            <img src="{{ baseUrl }}/img/personajes/main.png" alt="pac" class="imagestylesmall"></a>

            {% endif %}

          {% if game.mouse_user.id != request.user.id %}
            <div id="waiting" style="display: none">
                Esperando rival...
                <div class="gooey">
                  <span class="dot"></span>
                  <div class="dots">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>
                </div>
            </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock content %}